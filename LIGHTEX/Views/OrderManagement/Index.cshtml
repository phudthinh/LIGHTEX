@model LIGHTEX.Models.Brand;
@{
    ViewBag.Title = "Lịch sử giao dịch";
    Layout = "_LayoutAdmin";
}

@using Microsoft.AspNetCore.Http;
@using System.Diagnostics;
@using System.Linq;
@using System.Globalization;
@using LIGHTEX.Data
@using Microsoft.EntityFrameworkCore;

@inject IHttpContextAccessor HttpContextAccessor
@{
    int count = 0;
    string searchText = HttpContextAccessor.HttpContext.Request.Query["searchText"];

    var context = HttpContextAccessor?.HttpContext?.RequestServices.GetService(typeof(LIGHTEXContext)) as LIGHTEXContext;
    var bills = await context.Bill
    .Join(context.Product,
        bill => bill.id_product,
        product => product.id_product,
        (bill, product) => new { Bill = bill, Product = product })
    .Join(context.Customer,
        b => b.Bill.id_customer,
        c => c.id_customer,
        (b, c) => new { Bill = b.Bill, Product = b.Product, Customer = c })
    .OrderByDescending(b => b.Bill.create_date)
    .Where(b => searchText == null || b.Customer.username.Contains(searchText))
    .ToListAsync();
}
<body>
    <div class="flex flex-col gap-5">
        <h1 class="text-2xl lg:text-4xl text-black font-bold mb-4 text-center">Quản lý nhãn hàng</h1>
        <div class="flex justify-end items-center">
            <form method="get" class="relative">
                <div class="flex items-center justify-center">
                    <button id="submitBtn" type="submit" class="icon mx-2 w-auto h-6 absolute right-0 flex md:hover:scale-125 hover:cursor-pointer transition-all" disabled>
                        <svg class="fill-[#333333] w-full h-full" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 78.31 78.51">
                            <path d="M442,68.16a32.49,32.49,0,0,1,24.89,53.4l.82.83,1-1a2.15,2.15,0,0,1,3.06,0l15.42,15.45a2.12,2.12,0,0,1,0,3L481,146a2.15,2.15,0,0,1-3.06,0l-15.45-15.45a2.21,2.21,0,0,1,0-3.06l.76-.74-.85-.85A32.51,32.51,0,1,1,442,68.16Zm-15.11,34.27a2.16,2.16,0,1,1-2.16,2.15,2.15,2.15,0,0,1,2.16-2.15ZM429,97.24a2.16,2.16,0,0,1-2.72,1.39,2.2,2.2,0,0,1-1.39-2.75s4.93-15.28,18.6-12.22a2.17,2.17,0,0,1,1.64,2.58,2.13,2.13,0,0,1-2.58,1.62C432.74,85.65,429,97.21,429,97.24Zm32.85-16.49a28.19,28.19,0,1,0,8.25,19.92,28,28,0,0,0-8.25-19.92ZM470.16,126l-3.06,3.06,12.39,12.39,3.06-3Z" transform="translate(-409.44 -68.16)" />
                        </svg>
                    </button>
                    <input class="input__search" placeholder="Tìm kiếm..." name="searchText" type="text" onfocus="enableSubmit()" onblur="disableSubmit()">
                </div>
            </form>
        </div>
        <div class="rounded-lg overflow-hidden">
            <table class="w-full">
                <thead>
                    <tr class="h-14 w-full bg-[#6D7CD3] text-[#FFFFFF]">
                        <th class="px-3 py-1 text-center">Mã</th>
                        <th class="px-3 py-1 text-start">Tên người mua</th>
                        <th class="px-3 py-1 text-start">Sản phẩm</th>
                        <th class="px-3 py-1 text-start">Trạng thái</th>
                        <th class="px-3 py-1 text-start">Chi tiết</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var bill in bills)
                    {
                        <tr class="h-14 w-full last:rounded-b-lg @(count++ % 2 == 0 ? "bg-[#ececec]" : "bg-[#FFFFFF] border-y border-[#cccccc]")">
                            <td class="px-3 py-1"><p class="overflow-hidden overflow-ellipsis text-center">@bill.Bill.id_bill</p></td>
                            <td class="px-3 py-1"><p class="overflow-hidden overflow-ellipsis">@bill.Customer.username</p></td>
                            <td class="px-3 py-1"><p class="overflow-hidden overflow-ellipsis">@bill.Product.name</p></td>
                            <td class="px-3 py-1">
                                @if (@bill.Bill.status == 0)
                                {
                                    <p class="overflow-hidden overflow-ellipsis">Chờ xác nhận</p>
                                }
                                else @if (@bill.Bill.status == 1)
                                {
                                    <p class="overflow-hidden overflow-ellipsis text-[#FF6827]">Đang giao</p>
                                }
                                else @if (@bill.Bill.status == 2)
                                {
                                    <p class="overflow-hidden overflow-ellipsis text-[#0BDA51]">Hoàn thành</p>
                                }
                                else @if (@bill.Bill.status == 3)
                                {
                                    <p class="overflow-hidden overflow-ellipsis text-[#FF0000]">Hủy</p>
                                }
                                else @if (@bill.Bill.status == 4)
                                {
                                    <p class="overflow-hidden overflow-ellipsis font-bold">Trả hàng</p>
                                }
                            </td>
                            <td class="px-3 py-1">
                                <div class="w-8 h-8 flex justify-around items-center gap-2">
                                    <a class="group w-auto h-8 md:hover:scale-125 hover:cursor-pointer md:hover:animate-spin transition-all block" asp-area="" asp-controller="OrderManagement" asp-action="Detail" asp-route-id_bill="@bill.Bill.id_bill">
                                        <svg class="fill-[#333333] w-full h-full group-hover:fill-[#FF6827]" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 85.8 85.8">
                                            <path d="M297.45,377.9a42.88,42.88,0,1,1-30.36,12.56,42.91,42.91,0,0,1,30.36-12.56Zm-.06,65.45a4.91,4.91,0,0,1-3.88-1.5,6,6,0,0,1-1.39-4.31v-19a6,6,0,0,1,1.39-4.31,5,5,0,0,1,3.88-1.5,5.26,5.26,0,0,1,4,1.5,6.1,6.1,0,0,1,1.42,4.31v19a6.09,6.09,0,0,1-1.39,4.31,5.09,5.09,0,0,1-4,1.5Zm0-34.83a6.46,6.46,0,0,1-4.34-1.34,5.51,5.51,0,0,1,0-7.62,8.08,8.08,0,0,1,8.79,0,5.59,5.59,0,0,1,0,7.62,6.5,6.5,0,0,1-4.45,1.34Zm27.33-15A38.57,38.57,0,1,0,336,420.82a38.51,38.51,0,0,0-11.31-27.3Z" transform="translate(-254.53 -377.9)"/>
                                        </svg>
                                    </a>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
    <script>
        function enableSubmit() {
            document.getElementById("submitBtn").removeAttribute("disabled");
        }

        function disableSubmit() {
            if (document.querySelector(".input__search").value.length === 0) {
                document.getElementById("submitBtn").setAttribute("disabled", "true");
            }
        }
    </script>
</body>
