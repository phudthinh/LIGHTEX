@model LIGHTEX.Models.Brand;
@{
    ViewBag.Title = "Lịch sử giao dịch";
    Layout = "_LayoutAdmin";
}

@using Microsoft.AspNetCore.Http;
@using System.Diagnostics;
@using System.Linq;
@using System.Globalization;
@using LIGHTEX.Data
@using Microsoft.EntityFrameworkCore;

@inject IHttpContextAccessor HttpContextAccessor
@{
    int count = 0;
    string searchText = HttpContextAccessor.HttpContext.Request.Query["searchText"];

    var context = HttpContextAccessor?.HttpContext?.RequestServices.GetService(typeof(LIGHTEXContext)) as LIGHTEXContext;
    var bills = await context.Bill
    .Join(context.Product,
        bill => bill.id_product,
        product => product.id_product,
        (bill, product) => new { Bill = bill, Product = product })
    .Join(context.Customer,
        b => b.Bill.id_customer,
        c => c.id_customer,
        (b, c) => new { Bill = b.Bill, Product = b.Product, Customer = c })
    .OrderByDescending(b => b.Bill.create_date)
    .Where(b => searchText == null || b.Customer.username.Contains(searchText))
    .ToListAsync();
}
<body>
    <div class="flex flex-col gap-5">
        <h1 class="text-2xl lg:text-4xl text-black font-bold mb-4 text-center">Lịch sử giao dịch</h1>
        <div class="flex justify-end items-center">
            <form method="get" class="relative">
                <div class="flex items-center justify-center">
                    <button id="submitBtn" type="submit" class="icon mx-2 w-auto h-6 absolute right-0 flex md:hover:scale-125 hover:cursor-pointer transition-all" disabled>
                        <svg class="fill-[#333333] w-full h-full" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 78.31 78.51">
                            <path d="M442,68.16a32.49,32.49,0,0,1,24.89,53.4l.82.83,1-1a2.15,2.15,0,0,1,3.06,0l15.42,15.45a2.12,2.12,0,0,1,0,3L481,146a2.15,2.15,0,0,1-3.06,0l-15.45-15.45a2.21,2.21,0,0,1,0-3.06l.76-.74-.85-.85A32.51,32.51,0,1,1,442,68.16Zm-15.11,34.27a2.16,2.16,0,1,1-2.16,2.15,2.15,2.15,0,0,1,2.16-2.15ZM429,97.24a2.16,2.16,0,0,1-2.72,1.39,2.2,2.2,0,0,1-1.39-2.75s4.93-15.28,18.6-12.22a2.17,2.17,0,0,1,1.64,2.58,2.13,2.13,0,0,1-2.58,1.62C432.74,85.65,429,97.21,429,97.24Zm32.85-16.49a28.19,28.19,0,1,0,8.25,19.92,28,28,0,0,0-8.25-19.92ZM470.16,126l-3.06,3.06,12.39,12.39,3.06-3Z" transform="translate(-409.44 -68.16)" />
                        </svg>
                    </button>
                    <input class="input__search" placeholder="Tìm kiếm..." name="searchText" type="text" onfocus="enableSubmit()" onblur="disableSubmit()">
                </div>
            </form>
        </div>
        <div class="rounded-lg overflow-hidden">
            <table class="w-full">
                <thead>
                    <tr class="h-14 w-full bg-[#6D7CD3] text-[#FFFFFF]">
                        <th class="w-[35%] px-3 py-1 text-center">Sản phẩm</th>
                        <th class="w-[20%] px-3 py-1 text-start">Tên</th>
                        <th class="w-[15%] px-3 py-1 hidden md:table-cell text-start">Tổng tiền</th>
                        <th class="w-[15%] px-3 py-1 hidden md:table-cell text-start">Ngày giao</th>
                        <th class="w-[15%] px-3 py-1 text-start">Trạng thái</th>
                    </tr>
                </thead>
                <tbody class="bill-list">
                    @foreach (var bill in bills)
                    {
                        <tr class="h-14 w-full last:rounded-b-lg @(count++ % 2 == 0 ? "bg-[#ececec]" : "bg-[#FFFFFF] border-y border-[#cccccc]")">
                            <td class="w-full px-3 py-1 flex gap-2">
                                <img class="w-20 h-auto" src="data:image/png;base64,@(Convert.ToBase64String(bill.Product.image))" alt="image" />
                                <div class="flex flex-col h-20">
                                    <p class="hidden md:block overflow-hidden overflow-ellipsis text-xl text-start font-bold h-6">@bill.Product.name</p>
                                    <p class="hidden md:block overflow-hidden overflow-ellipsis text-justify h-14 pt-2 cart__item-information">@bill.Product.information</p>
                                </div>
                            </td>
                            <td class="w-[15%] px-3 py-1">
                                <p class="overflow-hidden overflow-ellipsis">@bill.Customer.username</p>
                            </td>
                            <td class="w-[15%] hidden md:table-cell px-3 py-1">
                                <div class="flex gap-2">
                                    <p class="text-xs overflow-hidden overflow-ellipsis">@bill.Product.price.ToString("N0", CultureInfo.CreateSpecificCulture("de-DE")).Replace(",", ".")đ</p>
                                    <p class="text-xs overflow-hidden overflow-ellipsis">x</p>
                                    <p class="text-xs overflow-hidden overflow-ellipsis">@bill.Bill.quantity</p>
                                </div>
                                @{
                                    var total = bill.Product.price * bill.Bill.quantity;
                                    <p class="text-xl text-[#FF6827] font-semibold">@total.ToString("N0", CultureInfo.CreateSpecificCulture("de-DE")).Replace(",", ".")đ</p>
                                }
                            </td>
                            <td class="w-[15%] hidden md:table-cell px-3 py-1">
                                <p class="overflow-hidden overflow-ellipsis">@bill.Bill.ship_date.ToString("dd-MM-yyyy")</p>
                            </td>
                            <td class="w-[15%] px-3 py-1">
                                @if (@bill.Bill.status == 0)
                                {
                                    <p class="overflow-hidden overflow-ellipsis">Chờ xác nhận</p>
                                }
                                else @if (@bill.Bill.status == 1)
                                {
                                    <p class="overflow-hidden overflow-ellipsis text-[#FF6827]">Đang giao</p>
                                }
                                else @if (@bill.Bill.status == 2)
                                {
                                    <p class="overflow-hidden overflow-ellipsis text-[#0BDA51]">Hoàn thành</p>
                                }
                                else @if (@bill.Bill.status == 3)
                                {
                                    <p class="overflow-hidden overflow-ellipsis text-[#FF0000]">Hủy</p>
                                }
                                else @if (@bill.Bill.status == 4)
                                {
                                    <p class="overflow-hidden overflow-ellipsis font-bold">Trả hàng</p>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
    <script>
        function enableSubmit() {
            document.getElementById("submitBtn").removeAttribute("disabled");
        }

        function disableSubmit() {
            if (document.querySelector(".input__search").value.length === 0) {
                document.getElementById("submitBtn").setAttribute("disabled", "true");
            }
        }
    </script>
</body>
