@{
    ViewData["Title"] = "Trang quản trị";
    Layout = "_LayoutAdmin";
}
@using Microsoft.AspNetCore.Http;
@using System.Diagnostics;
@using System.Linq;
@using LIGHTEX.Data
@using System.Globalization;

@using Microsoft.EntityFrameworkCore;

@inject IHttpContextAccessor HttpContextAccessor
@{
    int count = 0;
    var today = DateTime.Today;
    var monday = today.AddDays(-(int)today.DayOfWeek + (int)DayOfWeek.Monday);
    var tuesday = monday.AddDays(1);
    var wednesday = monday.AddDays(2);
    var thursday = monday.AddDays(3);
    var friday = monday.AddDays(4);
    var saturday = monday.AddDays(5);
    var sunday = monday.AddDays(6);
    double totalToDay = 0;
    double goalToDay = 10000000;

    double totalMonday = 0;
    double totalTuesday = 0;
    double totalWednesday = 0;
    double totalThursday = 0;
    double totalFriday = 0;
    double totalSaturday = 0;
    double totalSunday = 0;
    double goalOfWeek = 100000000;

    var context = HttpContextAccessor?.HttpContext?.RequestServices.GetService(typeof(LIGHTEXContext)) as LIGHTEXContext;
    var customers = context.Customer
    .Join(context.Account,
        c => c.username,
        a => a.username,
        (c, a) => new { Customer = c, Account = a })
        .Where(a => a.Account.permission == 0 && a.Account.create_date.Date == today)
    .Select(ac => new { ac.Customer, ac.Account.full_name })
    .ToList();
    var billSum = await context.Bill.Where(a => a.ship_date.Date == today).ToListAsync();
    var billDone = await context.Bill.Where(a => a.ship_date.Date == today && a.status == 2).ToListAsync();
    var billError = await context.Bill.Where(a => a.ship_date.Date == today && a.status == 3).ToListAsync();

    var billToDay = await context.Bill
       .Where(a => a.ship_date.Date == today && a.status == 2)
       .Join(context.Product,
            bill => bill.id_product,
            product => product.id_product,
            (bill, product) => new { Bill = bill, Product = product })
        .ToListAsync();

    foreach (var bill in billToDay)
    {
        totalToDay = totalToDay + (bill.Product.price * bill.Bill.quantity);
    }
    double percentGoal = (totalToDay / goalToDay) * 100;

    var billToWeek = await context.Bill
        .Where(a => a.ship_date.Date >= monday && a.ship_date.Date <= sunday && a.status == 2)
        .Join(context.Product,
            bill => bill.id_product,
            product => product.id_product,
            (bill, product) => new { Bill = bill, Product = product })
        .ToListAsync();


    foreach (var bill in billToWeek)
    {
        if (bill.Bill.ship_date.Date == monday)
        {
            totalMonday = totalMonday + (bill.Product.price * bill.Bill.quantity);
        }
        if (bill.Bill.ship_date.Date == tuesday)
        {
            totalTuesday = totalTuesday + (bill.Product.price * bill.Bill.quantity);
        }
        if (bill.Bill.ship_date.Date == wednesday)
        {
            totalWednesday = totalWednesday + (bill.Product.price * bill.Bill.quantity);
        }
        if (bill.Bill.ship_date.Date == thursday)
        {
            totalThursday = totalThursday + (bill.Product.price * bill.Bill.quantity);
        }
        if (bill.Bill.ship_date.Date == friday)
        {
            totalFriday = totalFriday + (bill.Product.price * bill.Bill.quantity);
        }
        if (bill.Bill.ship_date.Date == saturday)
        {
            totalSaturday = totalSaturday + (bill.Product.price * bill.Bill.quantity);
        }
        if (bill.Bill.ship_date.Date == sunday)
        {
            totalSunday = totalSunday + (bill.Product.price * bill.Bill.quantity);
        }
    }
    double sumWeek = totalMonday + totalTuesday + totalWednesday + totalThursday + totalFriday + totalSaturday + totalSunday;
    double percentGoalMonday = (totalMonday / goalToDay) * 100;
    double percentGoalTuesday = (totalTuesday / goalToDay) * 100;
    double percentGoalWednesday = (totalWednesday / goalToDay) * 100;
    double percentGoalThursday = (totalThursday / goalToDay) * 100;
    double percentGoalFriday = (totalFriday / goalToDay) * 100;
    double percentGoalSaturday = (totalSaturday / goalToDay) * 100;
    double percentGoalSunday = (totalSunday / goalToDay) * 100;

    double percentGoalWeek = (sumWeek / goalOfWeek) * 100;


}
<div class="flex flex-col md:flex-row items-center justify-center bg-gray-50 p-4">
    <div class="flex flex-col w-full lg:w-1/2 h-96">
        <div class="bg-white shadow-lg rounded-xl flex items-start justify-center py-4 px-8 mx-4 my-2">
                <div class="flex items-center justify-start w-full">
                    <div class="flex-col w-[85%]">
                        <div class="text-sm font-medium text-[#6D7CD3] my-2">Tổng doanh thu trong ngày</div>
                        <div class="class flex items-center">
                        <div class="text-3xl font-bold text-gray-700">@totalToDay.ToString("N0", CultureInfo.CreateSpecificCulture("de-DE")).Replace(",", ".")đ</div>
                            <div class="flex items-center justify-between mx-2 px-0.5 py-0.5 rounded-xl text-green-500 font-medium hidden md:block">
                            <div class="text-xs bg-green-200 px-2 rounded-lg">+ @percentGoal.ToString("0.00")%</div>
                            </div>
                        </div>
                        <div class="w-full h-1 rounded bg-gray-300 my-1">
                        <div class="w-[@percentGoal.ToString("0.00")%] h-1 rounded bg-green-500"></div>
                        </div>
                    <div class="text-xs font-medium text-gray-400 ">Mục tiêu: @goalToDay.ToString("N0", CultureInfo.CreateSpecificCulture("de-DE")).Replace(",", ".")đ</div>
                    </div>
                </div>
            </div>
        <div class="bg-white shadow-lg rounded-xl flex items-start justify-center py-4 px-8 mx-4 my-2">
            <div class="flex items-center justify-start w-full">
                <div class="flex-col w-[85%]">
                    <div class="text-sm font-medium text-[#6D7CD3] my-2">Thu nhập trong tuần</div>
                    <div class="class flex items-center">
                        <div class="text-3xl font-bold text-gray-700">@sumWeek.ToString("N0", CultureInfo.CreateSpecificCulture("de-DE")).Replace(",", ".")đ</div>
                        <div class="flex items-center justify-between mx-2 px-0.5 py-0.5 rounded-xl text-green-500 font-medium hidden md:block">
                            <div class="text-xs bg-green-200 px-2 rounded-lg">+ @percentGoalWeek.ToString("0.00")%</div>
                        </div>
                    </div>
                    <div class="flex items-center justify-between mt-4">
                        <div class="w-[12%]">
                            <div class="h-16 rounded-tr rounded-tl bg-gray-100 mx-2">
                                <div class="h-[@percentGoalMonday.ToString("0.00")%] rounded-tr rounded-tl bg-green-300"></div>
                            </div>
                            <div class="text-xs font-medium mt-1 text-center text-gray-500 hidden md:block">Mon</div>
                        </div>
                        <div class="w-[12%]">
                            <div class="h-16 rounded-tr rounded-tl bg-gray-100 mx-2">
                                <div class="h-[@percentGoalTuesday.ToString("0.00")%] rounded-tr rounded-tl bg-green-300"></div>
                            </div>
                            <div class="text-xs font-medium mt-1 text-center text-gray-500 hidden md:block">Tue</div>
                        </div>
                        <div class="w-[12%]">
                            <div class="h-16 rounded-tr rounded-tl bg-gray-100 mx-2">
                                <div class="h-[@percentGoalWednesday.ToString("0.00")%] rounded-tr rounded-tl bg-green-300"></div>
                            </div>
                            <div class="text-xs font-medium mt-1 text-center text-gray-500 hidden md:block">Wed</div>
                        </div>
                        <div class="w-[12%]">
                            <div class="h-16 rounded-tr rounded-tl bg-gray-100 mx-2">
                                <div class="h-[@percentGoalThursday%] rounded-tr rounded-tl bg-green-300"></div>
                            </div>
                            <div class="text-xs font-medium mt-1 text-center text-gray-500 hidden md:block">Thu</div>
                        </div>
                        <div class="w-[12%]">
                            <div class="h-16 rounded-tr rounded-tl bg-gray-100 mx-2">
                                <div class="h-[@percentGoalFriday.ToString("0.00")%] rounded-tr rounded-tl bg-green-300"></div>
                            </div>
                            <div class="text-xs font-medium mt-1 text-center text-gray-500 hidden md:block">Fri</div>
                        </div>
                        <div class="w-[12%]">
                            <div class="h-16 rounded-tr rounded-tl bg-gray-100 mx-2">
                                <div class="h-[@percentGoalSaturday.ToString("0.00")%] rounded-tr rounded-tl bg-green-300"></div>
                            </div>
                            <div class="text-xs font-medium mt-1 text-center text-gray-500 hidden md:block">Sat</div>
                        </div>
                        <div class="w-[12%]">
                            <div class="h-16 rounded-tr rounded-tl bg-gray-100 mx-2">
                                <div class="h-[@percentGoalSunday.ToString("0.00")%] rounded-tr rounded-tl bg-green-300"></div>
                            </div>
                            <div class="text-xs font-medium mt-1 text-center text-gray-500 hidden md:block">Sun</div>
                        </div>
                    </div>
                    <div class="text-xs font-medium text-gray-400 mt-4">Mục tiêu: @goalOfWeek.ToString("N0", CultureInfo.CreateSpecificCulture("de-DE")).Replace(",", ".")đ</div>

                </div>
            </div>
        </div>
    </div>
    <div class="flex flex-col w-full lg:w-1/2 h-max md:h-96 my-4 md:my-0">
        <div class="bg-white shadow-lg rounded-xl flex items-start justify-center py-4 px-8 mx-4 my-2">
            <div class="flex items-center justify-start w-full">
                <div class="flex-col w-[100%]">
                    <div class="text-sm font-medium text-[#6D7CD3] my-2">Người dùng mới trong ngày</div>
                    <div class="rounded-lg overflow-hidden">
                        <table class="w-full">
                            <thead>
                                <tr class="h-14 w-full bg-[#6D7CD3] text-[#FFFFFF]">
                                    <th class="w-[33%] md:w-[33%] lg:w-[33%] px-3 py-1 text-center">Ảnh đại diện</th>
                                    <th class="w-[33%] md:w-[33%] lg:w-[33%] px-3 py-1 text-start">Tài khoản</th>
                                    <th class="w-0 md:w-[33%] hidden lg:table-cell lg:w-[33%] px-3 py-1 text-start">Tên</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var customer in customers.Take(4))
                                {
                                    <tr class="h-14 w-full last:rounded-b-lg @(count++ % 2 == 0 ? "bg-[#ececec]" : "bg-[#FFFFFF] border-y border-[#cccccc]")">
                                        <td class="w-[35%] md:w-[33%] lg:w-[33%] px-3 py-1 h-14">
                                            @if (customer.Customer.avatar.SequenceEqual(new byte[0]))
                                            {
                                                <div class="flex justify-center items-center w-full h-full">
                                                    <span class="w-10 h-auto">
                                                        <svg class="fill-[#333333] w-full h-full" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 98.39 98.16">
                                                            <path d="M488.83,134.58a2.14,2.14,0,1,1-3.46-2.53,42.52,42.52,0,0,0,8.22-25.14,44.55,44.55,0,0,0-18.11-35.72,46.78,46.78,0,0,0-53.55,0,44.41,44.41,0,0,0-18.08,35.72,42.24,42.24,0,0,0,8.22,25.14,2.17,2.17,0,0,1-.49,3,2.14,2.14,0,0,1-3-.48,46.65,46.65,0,0,1-9.07-27.67,48.82,48.82,0,0,1,5.24-21.86,48,48,0,0,1,14.66-17.32,49,49,0,0,1,29.28-9.29h0A49,49,0,0,1,478,67.73a48.3,48.3,0,0,1,14.68,17.32,48.8,48.8,0,0,1,5.22,21.86,46.65,46.65,0,0,1-9.07,27.67Zm-36.31-7.49a4.58,4.58,0,0,1,.56.14c7.52.77,19.25,3.66,28.46,13.75a2.17,2.17,0,0,1,.14,2.72c-.76,1.16-8.27,11.62-29.9,12.79a2.76,2.76,0,0,1-.65.11c-.68,0-1.36,0-2,0s-1.36,0-2,0a2.76,2.76,0,0,1-.66-.11c-21.62-1.17-29.14-11.63-29.9-12.79a2.17,2.17,0,0,1,.14-2.72c9.21-10.09,20.95-13,28.43-13.75.2,0,.4-.11.6-.14a73.57,73.57,0,0,1,6.86,0Zm-3.43,4.2c-5.67.08-18.17,1.47-28,11.31,2.55,2.83,10.32,9.38,28,9.69,17.68-.31,25.45-6.86,28-9.69-9.83-9.84-22.33-11.23-28-11.31Zm-.37-48a17.92,17.92,0,1,1-12.64,5.25,17.91,17.91,0,0,1,12.64-5.25Zm9.58,8.31a13.54,13.54,0,1,0,4,9.58,13.49,13.49,0,0,0-4-9.58Z" transform="translate(-399.51 -58.44)" />
                                                        </svg>
                                                    </span>
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="flex justify-center items-center w-full h-full">
                                                    <span class="w-6 md:w-10 h-6 md:h-10">
                                                        <img class="w-full h-full rounded-full border-2 border-[#333333] object-cover" src="data:image/png;base64,@(Convert.ToBase64String(customer.Customer.avatar))" alt="image" />
                                                    </span>
                                                </div>
                                            }
                                        </td>
                                        <td class="w-[33%] md:w-[33%] lg:w-[33%] px-3 py-1"><p class="overflow-hidden overflow-ellipsis">@customer.Customer.username</p></td>
                                        <td class="w-0 md:w-[33%] hidden lg:table-cell lg:w-[33%] px-3 py-1"><p class="overflow-hidden overflow-ellipsis">@customer.full_name</p></td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>
<div class="flex flex-col md:flex-row items-center justify-center bg-gray-50 p-4">
    <div class="bg-white shadow-lg rounded-xl flex flex-col items-center justify-center py-4 px-8 mx-4 my-2 w-full md:w-[25%] h-48 gap-4">
        <p class="text-xl font-medium text-center">Đơn bán trong ngày</p>
        <h1 class="text-6xl text-[#333333] font-bold text-center">@billSum.Count</h1>
    </div>
    <div class="bg-[#a9ecbf] shadow-lg rounded-xl flex flex-col items-center justify-center py-4 px-8 mx-4 my-2 w-full md:w-[25%] h-48 gap-4">
        <p class="text-xl font-medium text-center text-[#42c16e]">Đơn thành công</p>
        <h1 class="text-6xl text-white font-bold text-center">@billDone.Count</h1>
    </div>
    <div class="bg-[#f3bbe1] shadow-lg rounded-xl flex flex-col items-center justify-center py-4 px-8 mx-4 my-2 w-full md:w-[25%] h-48 gap-4">
        <p class="text-xl font-medium text-center text-[#dc5bb7]">Đơn thất bại</p>
        <h1 class="text-6xl text-white font-bold text-center">@billError.Count</h1>
    </div>
    <div class="bg-[#6D7CD3] shadow-lg rounded-xl flex flex-col items-center justify-center py-4 px-8 mx-4 my-2 w-full md:w-[25%] h-48 gap-4">
        <p class="text-xl font-medium text-center text-white">Người dùng mới</p>
        <h1 class="text-6xl text-white font-bold text-center">@customers.Count</h1>
    </div>
</div>
<script src="https://cdn.tailwindcss.com"></script>
